<!DOCTYPE html><html><head><script>var host = ".github.io"; if (/\.github.io/.test(window.location.host) && window.location.protocol != "https:") window.location.protocol = "https";</script><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, target-densityDpi=medium-dpi"><meta content="True" name="HandheldFriendly"><title>A hint of chaos</title><link rel="shortcut icon" href="/ico/favicon.ico"><link rel="stylesheet" href="/styles/style.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css"><link rel="alternate" type="application/rss+xml" title="spion.github.io" href="/rss.xml"></head><body><div class="main"><aside class="info-tiny"><a class="img" href="/"><img src="https://secure.gravatar.com/avatar/d924ad2ac22af6216aadd2e9184616de?s=144"></a><h1 class="first"><a href="/">Gorgi Kosev</a></h1><p class="subtitle">code, music, math</p></aside><div class="info"><a class="img" href="/"><img src="https://secure.gravatar.com/avatar/d924ad2ac22af6216aadd2e9184616de?s=144"></a><h1 class="first"><a href="/">Gorgi Kosev</a></h1><p class="subtitle">code, music, math</p><p class="subtitle margin"><a href="http://twitter.com/spion">@spion</a></p></div><main class="rest"><div><article class="post"><h1><a href="posts/growth-rate-matters/index.html">COVID-19: Case counts don't matter. Growth does</a></h1><div class="date">Thu Sep 10 2020</div><div class="content"><p>The growth of cases is another hot and controversial COVID topic. On one hand, the number of daily is getting to be very large in many European countries. On the other, it doesn't look like this rise in cases is having the same impact as it had before. There is a theory that proposes there might be a lot of dead virus being detected, as well as that the increased amount of testing is the reason behind the increased amount of cases, most of them asymptomatic. As such, we should be ignoring the case numbers and focus on other metrics such as hospitalizations.</p>
<p>In this blog post I hope to convince that case numbers aren't useless. But we should neither be looking at the absolute number of cases nor wait for hospitalizations and deaths to kick in. Instead, we should be looking at the growth rate (or <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> estimates). Through the growth rate, the case counts, no matter how flawed can provide a great early warning system.</p>
<h3>The case of Spain</h3>
<p>One of the first countries to have a &quot;second wave&quot; of cases was Spain. Lets load up the &quot;our world in data&quot; dataset and compare the two waves to see how they look like.</p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
plt.rcParams[<span class="hljs-string">'figure.dpi'</span>] = <span class="hljs-number">150</span>
plt.rcParams[<span class="hljs-string">'figure.figsize'</span>] = [<span class="hljs-number">6.0</span>, <span class="hljs-number">4.0</span>]
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
dateparse = <span class="hljs-keyword">lambda</span> x: datetime.strptime(x, <span class="hljs-string">'%Y-%m-%d'</span>)
owid = pd.read_csv(<span class="hljs-string">'https://covid.ourworldindata.org/data/owid-covid-data.csv'</span>, parse_dates=[<span class="hljs-string">'date'</span>], date_parser=dateparse)

</code></pre>
<p>Spain's first wave started at the beginning of March, while the second wave is still ongoing in August. Lets plot those on the same chart:</p>
<pre><code class="language-python">esp = owid[owid.iso_code.eq(<span class="hljs-string">"ESP"</span>)]

wave1 = esp.loc[(owid[<span class="hljs-string">'date'</span>] &gt; <span class="hljs-string">'03-01-2020'</span>) &amp; (owid[<span class="hljs-string">'date'</span>] &lt;= <span class="hljs-string">'03-29-2020'</span>)];
wave2 = esp.loc[(owid[<span class="hljs-string">'date'</span>] &gt; <span class="hljs-string">'08-01-2020'</span>) &amp; (owid[<span class="hljs-string">'date'</span>] &lt;= <span class="hljs-string">'08-29-2020'</span>)];

wave1 = wave1.reset_index().rename(columns={<span class="hljs-string">'new_cases_smoothed'</span>: <span class="hljs-string">'Spain March'</span>})[<span class="hljs-string">'Spain March'</span>]
wave2 = wave2.reset_index().rename(columns={<span class="hljs-string">'new_cases_smoothed'</span>: <span class="hljs-string">'Spain August'</span>})[<span class="hljs-string">'Spain August'</span>]
</code></pre>
<pre><code class="language-python">plot = pd.concat([wave1, wave2], axis=<span class="hljs-number">1</span>).plot(grid=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_4_0.png" alt="png"></p>
<p>The chart looks very scary, but we can't easily infer the growth rate of the virus by looking at it. Lets try a log plot:</p>
<pre><code class="language-python">plot = pd.concat([wave1, wave2], axis=<span class="hljs-number">1</span>).plot(logy=<span class="hljs-literal">True</span>, grid=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_6_0.png" alt="png"></p>
<p>Ok, thats interesting. It appears that despite the case numbers being very high, the growth is significantly slower this time around. Lets try and compare the 5-day rate of growth (which should be pretty close to <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>)</p>
<pre><code class="language-python">wave1growth = wave1.pct_change(periods=<span class="hljs-number">5</span>) + <span class="hljs-number">1</span>
wave2growth = wave2.pct_change(periods=<span class="hljs-number">5</span>) + <span class="hljs-number">1</span>
plot = pd.concat([wave1growth, wave2growth], axis=<span class="hljs-number">1</span>).plot(grid=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_8_0.png" alt="png"></p>
<p>Wow, that is a huge difference. The rate of spread is not even close to the level in March. Lets try zooming in on the period in the middle of the month</p>
<pre><code class="language-python">wave1growth = wave1.pct_change(periods=<span class="hljs-number">5</span>).iloc[<span class="hljs-number">15</span>:] + <span class="hljs-number">1</span>
wave2growth = wave2.pct_change(periods=<span class="hljs-number">5</span>).iloc[<span class="hljs-number">15</span>:] + <span class="hljs-number">1</span>
plot = pd.concat([wave1growth, wave2growth], axis=<span class="hljs-number">1</span>).plot(grid=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_10_0.png" alt="png"></p>
<p>It looks like the growth rate barely went close to 1.5 in August, while in March it was well above 2 for the entire month!</p>
<p>But, why is the growth rate so important? I'll try and explain</p>
<h2>The growth rate is the most important metric</h2>
<p>There are several reasons why the growth rate is so important</p>
<h4>Its resistant to errors or CFR changes</h4>
<p>Yes, the rate of growth is largely resilient to errors, as long as the nature of those errors doesn't change much over a short period of time!</p>
<p>Lets assume that 5% of the PCR tests are false positives. Lets say the number of daily tests is <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>N</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">N_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, of which 12% is the percentage of true positives today, while 10% is the number of true positives 5 days ago. In this situation, one third of our tests consist of errors - thats a lot!</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mn>0.05</mn><msub><mi>N</mi><mi>t</mi></msub><mo>+</mo><mn>0.12</mn><mi>N</mi><mi>t</mi></mrow><mrow><mn>0.05</mn><msub><mi>N</mi><mi>t</mi></msub><mo>+</mo><mn>0.1</mn><mo>∗</mo><mi>N</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mfrac><mn>17</mn><mn>15</mn></mfrac></mrow><annotation encoding="application/x-tex">R_t = {0.05N_t + 0.12Nt \over 0.05N_t + 0.1*Nt} = {17 \over  15} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.19633em;vertical-align:-0.8360000000000001em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">5</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span>
<p>Without the errors, we would get</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mn>0.12</mn><mi>N</mi><mi>t</mi></mrow><mrow><mn>0.1</mn><mo>∗</mo><mi>N</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mfrac><mn>12</mn><mn>10</mn></mfrac><mo>=</mo><mfrac><mn>18</mn><mn>15</mn></mfrac></mrow><annotation encoding="application/x-tex">R_t = {0.12Nt \over 0.1*Nt} = {12 \over 10} = {18 \over 15} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">5</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span>
<p>Pretty close - and whats more, the increase in errors causes under-estimation, not over-estimation! Note that growth means that the error will matter less and less over time unless tests scale up proportionally.</p>
<p>A similar argument can be made for people who have already had the virus, where the PCR detects virus that is no longer viable. We would expect the number of cases to track the number of tests, so the rate of growth would likely be lower, not higher.</p>
<blockquote>
<p>Note: the case with asymptomatics is slightly different. We could be uncovering clusters at their tail end. But once testing is at full capacity, the probability is that we would uncover those earlier rather than later, as the number of active cases would be declining at that point.</p>
</blockquote>
<h4>It can be adjusted for percentage of positive tests</h4>
<p>Lets say that the number of tests is changing too quickly. Is this a problem?</p>
<p>Not really. From the rate of growth, we can compensate for the test growth component, easily.</p>
<table>
<thead>
<tr>
<th>x</th>
<th>Cases</th>
<th>Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td>Today</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>N</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">N_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>5d ago</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>N</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">N_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
</tr>
</tbody>
</table>
<p>The adjusted rate of growth is</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub><mi>a</mi><mo>=</mo><mfrac><mrow><msub><mi>N</mi><mn>2</mn></msub><msub><mi>T</mi><mn>1</mn></msub></mrow><mrow><msub><mi>N</mi><mn>1</mn></msub><msub><mi>T</mi><mn>2</mn></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">R_ta = {N_2 T_1 \over N_1 T_2} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.19633em;vertical-align:-0.8360000000000001em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span>
<h4>Better picture than absolute numbers</h4>
<p>Its best not to look at absolute numbers at all. Hindsight is 20:20, so lets see what the world looked like in Spain from the perspective of March 11th:</p>
<pre><code class="language-python">esp_march = esp.loc[(owid[<span class="hljs-string">'date'</span>] &gt; <span class="hljs-string">'03-01-2020'</span>) &amp; (owid[<span class="hljs-string">'date'</span>] &lt;= <span class="hljs-string">'03-11-2020'</span>)];
plot = esp_march.plot(grid=<span class="hljs-literal">True</span>, x=<span class="hljs-string">'date'</span>, y=<span class="hljs-string">'new_cases_smoothed'</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_13_0.png" alt="png"></p>
<p>Only 400 cases, nothing to worry about. But if we look at <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> instead</p>
<pre><code class="language-python">esp_march_growth = esp_march.reset_index()[<span class="hljs-string">'new_cases_smoothed'</span>].pct_change(periods=<span class="hljs-number">5</span>)
plot = esp_march_growth.plot(grid = <span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/growth-rate-matters/output_15_0.png" alt="png"></p>
<p>The rate of growth is crazy high! We must do something about it!</p>
<h4>It encompasses everything else we do or know</h4>
<p>Antibody immunity, T-cell immunity, lockdowns and masks. Their common theme is that they all affect
or try to affect the rate of growth:</p>
<ul>
<li>If a random half of the population magically became immune tomorrow, the growth rate will probably
be halved as well</li>
<li>If masks block half of the infections, the growth rate would also be halved.</li>
<li>If 20% of the population stays at home, the number of potential interactions goes down to 64% - a
one third reduction in the rate of growth (most likely)</li>
</ul>
<h4>Early growth dominates all other factors</h4>
<p>With the following few examples lets demonstrate that getting an accurate estimate of the growth rate and its early control is the most important thing and other factors (absolute number of cases, exact CFR etc) are mostly irrelevant</p>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_growth</span><span class="hljs-params">(pairs)</span>:</span>
    result = [<span class="hljs-number">1</span>]
    num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> days, growth <span class="hljs-keyword">in</span> pairs:
        <span class="hljs-keyword">while</span> days &gt; <span class="hljs-number">0</span>:
            num = num * growth
            result.append(num)
            days = days - <span class="hljs-number">1</span>

    <span class="hljs-keyword">return</span> result

big_growth = generate_growth([(<span class="hljs-number">14</span>, <span class="hljs-number">1.5</span>), (<span class="hljs-number">21</span>, <span class="hljs-number">1.05</span>)])
small_growth = generate_growth([(<span class="hljs-number">42</span>, <span class="hljs-number">1.2</span>)])

df = pd.DataFrame(list(zip(big_growth, small_growth)), columns=[<span class="hljs-string">'big_growth'</span>, <span class="hljs-string">'small_growth'</span>])

df.plot()
</code></pre>
<p><img src="/posts/growth-rate-matters/output_18_1.png" alt="png"></p>
<p>In the above chart, &quot;big growth&quot; represents a country with a big daily growth rate of 50% for only 2 weeks, followed by a much lower growth rate of 5% caused by a stringent set of measures. &quot;small growth&quot; represents a country with a daily growth rate of 20% that never implemented any measures.</p>
<p>This chart makes it clear that growth rate trumps all other factors. If a country's growth rate is small, they can afford not to have any measures for a very long time. If however the growth rate is high, they cannot afford even two weeks of no measures - by that point its already very late.</p>
<pre><code class="language-python">
</code></pre>
</div><div class="comments"><hr/><a href="posts/growth-rate-matters/index.html#_comments">comment or share</a></div></article><article class="post"><h1><a href="posts/uk-sweden-growth/index.html">COVID-19: Can you really compare the UK to Sweden?</a></h1><div class="date">Sat Sep 05 2020</div><div class="content"><p>When it comes to COVID-19, Sweden seems to be mentioned as a good model to follow quite often by lockdown skeptics. The evidence they give is that despite not locking down, Sweden did comparably well to many other European countries that did lock down - for example, the UK.</p>
<p>Lets see why this comparison is inadequate as the countries were behaving very differently before any lockdown or mass measures were introduced.</p>
<p>This entire blog post is a valid Jupyther notebook. It uses data that is fully available online. You should be able to copy the entire thing and paste it into Jupyther, run it yourself, tweak any parameters you want. It should make it easier to review the work if you wish to do that, or try and twist the data to prove your own point.</p>
<p>Lets load up both countries stats from ourworldindata:</p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

plt.rcParams[<span class="hljs-string">'figure.dpi'</span>] = <span class="hljs-number">150</span>
plt.rcParams[<span class="hljs-string">'figure.figsize'</span>] = [<span class="hljs-number">6.0</span>, <span class="hljs-number">4.0</span>]
dateparse = <span class="hljs-keyword">lambda</span> x: datetime.strptime(x, <span class="hljs-string">'%Y-%m-%d'</span>)
owid_url = <span class="hljs-string">'https://covid.ourworldindata.org/data/owid-covid-data.csv'</span>
owid = pd.read_csv(owid_url, parse_dates=[<span class="hljs-string">'date'</span>], date_parser=dateparse)
</code></pre>
<p>We can get the countries data by their ISO code</p>
<pre><code class="language-python">codes = [<span class="hljs-string">"GBR"</span>, <span class="hljs-string">"SWE"</span>, <span class="hljs-string">"ITA"</span>, <span class="hljs-string">"IRL"</span>, <span class="hljs-string">"ESP"</span>, <span class="hljs-string">"FRA"</span>]
</code></pre>
<p>Now lets compare deaths. We'll start the comparison when both countries deaths per million go above 0.25 per day to match the percentage of succeptable people. We're using the weekly moving average column from ourworldindata in order to get a better sense of the trend. We're going to take 5 weeks of data</p>
<pre><code class="language-python">countries = {}

populations = { <span class="hljs-comment"># in million</span>
    <span class="hljs-string">"GBR"</span>: <span class="hljs-number">66.0</span>,
    <span class="hljs-string">"SWE"</span>:  <span class="hljs-number">10.0</span>,
    <span class="hljs-string">"ITA"</span>:  <span class="hljs-number">60.0</span>,
    <span class="hljs-string">"IRL"</span>:  <span class="hljs-number">5.0</span>,
    <span class="hljs-string">"ESP"</span>: <span class="hljs-number">47.0</span>,
    <span class="hljs-string">"FRA"</span>:<span class="hljs-number">67.0</span>
}

<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> codes:
    cntr = owid[(owid.iso_code.eq(name)) &amp; (owid.new_deaths_smoothed / populations[name] &gt; <span class="hljs-number">0.25</span>)]
    reindexed = cntr.reset_index()
    countries[name] = reindexed;

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">take</span><span class="hljs-params">(name)</span>:</span>
    <span class="hljs-keyword">return</span> countries[name].rename(columns={<span class="hljs-string">'new_deaths_smoothed'</span>: name})[name]


plot = pd.concat([take(<span class="hljs-string">'GBR'</span>), take(<span class="hljs-string">'SWE'</span>)], axis = <span class="hljs-number">1</span>).iloc[:<span class="hljs-number">35</span>].plot(grid=<span class="hljs-literal">True</span>, logy=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="output_5_0.png" alt="png"></p>
<p>Okay, so it looks like the deaths in the UK were growing a bit faster than the deaths in Sweden from the very beginning! Lets look at the growth rate with period 5 days. This growth rate should be a crude approximation of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> - its based on the fact that people seem to be most infections around 5 days after contracting the virus. To avoid noisiness when the number of deaths is very low, we'll add <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">1 \over 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> death per million of population. This should cause <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to drop closer to 1 when deaths per million are fairly low:</p>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">growth</span><span class="hljs-params">(name)</span>:</span>
    <span class="hljs-keyword">return</span> (take(name) + populations[name]/<span class="hljs-number">2</span>).pct_change(periods=<span class="hljs-number">5</span>) + <span class="hljs-number">1</span>

plot = pd.concat([growth(<span class="hljs-string">'GBR'</span>), growth(<span class="hljs-string">'SWE'</span>)], axis = <span class="hljs-number">1</span>).iloc[:<span class="hljs-number">35</span>].plot(grid=<span class="hljs-literal">True</span>, logy=<span class="hljs-literal">True</span>)

</code></pre>
<p><img src="/posts/uk-sweden-growth/output_7_0.png" alt="png"></p>
<p>It looks like the rate of growth was higher in the UK during a crucial 10 day period before the middle of March, with a growth factor (analog to <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) that is about 30% higher. Now lets try and extrapolate what was going on in terms of cases that produced these deaths.</p>
<p>The mean time from infection to death for patients with fatal outcomes is 21 days. The standard deviation has been estimated to be anywhere between 5 and 7 days. Lets try to keep things simple and stick to 21 days</p>
<pre><code class="language-python">case_ranges = {}

<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> codes:
    case_ranges[name] = [countries[name].iloc[<span class="hljs-number">0</span>][<span class="hljs-string">'date'</span>]  - timedelta(days=<span class="hljs-number">21</span>), countries[name].iloc[<span class="hljs-number">0</span>][<span class="hljs-string">'date'</span>]  + timedelta(days=<span class="hljs-number">14</span>)]

print(<span class="hljs-string">'GBR'</span>, case_ranges[<span class="hljs-string">'GBR'</span>][<span class="hljs-number">0</span>], <span class="hljs-string">'to'</span>, case_ranges[<span class="hljs-string">'GBR'</span>][<span class="hljs-number">1</span>])
print(<span class="hljs-string">'SWE'</span>, case_ranges[<span class="hljs-string">'SWE'</span>][<span class="hljs-number">0</span>], <span class="hljs-string">'to'</span>, case_ranges[<span class="hljs-string">'SWE'</span>][<span class="hljs-number">1</span>])
</code></pre>
<pre><code>GBR 2020-02-28 00:00:00 to 2020-04-03 00:00:00
SWE 2020-02-28 00:00:00 to 2020-04-03 00:00:00
</code></pre>
<p>This means that the dates where we observe these rates of growth begin on the 1th of March in both UK and in Sweden. Point 5 in the plot is therefore March 5th.</p>
<p>So what happened between March 5th and March 18th in the UK, where the rate of growth seemed to have been between quite high? And what happened in Sweden?</p>
<h3>UK: Contact tracing</h3>
<p>Contact tracing is a reasonably decent strategy. Assuming you have enough capacity, you should be able to find everyone in contact with the infected person, and also their contacts and so on. It should work reasonably well for most viruses, especially those that have mainly symptomatic spread.</p>
<p>Unfortunately SARS-COV-2 seems to have had an asymptomatic component. The virus quickly entered the community spread phase.</p>
<p>PHE gave up on contact tracing due to being overwhelmed on March 11th. That would be somewhere afterpoint 20. Growth rate still very high, above 2.0. No measures were in place at that time.</p>
<p>After an additional week or two of nothing much, UK finally implemented a lockdown on March 23rd</p>
<h3>Sweden: Mass measures</h3>
<ul>
<li>Feb 27th: Almega, the largest organization of service companies in Sweden advised employees to stay at home if they visited high risk areas</li>
<li>March 3rd: The Scandinavian airline SAS stopped all flights to northern Italy</li>
<li>March 11: The government announced that the qualifying day of sickness ('karensdag') will be temporarily abolished in order to ensure that people feeling slightly ill will stay at home from work. This means that the state will pay sick pay allowance from the first day the employee is absent from work</li>
</ul>
<h2>Mobility trends</h2>
<p>But these are all just decrees. Lets see what really happened by looking at google mobility trends</p>
<pre><code class="language-python">dateparse = <span class="hljs-keyword">lambda</span> x: datetime.strptime(x, <span class="hljs-string">'%b %d, %Y'</span>)
mobility = pd.read_csv(<span class="hljs-string">'https://drive.google.com/u/0/uc?id=1M4GY_K4y6KZtkDtz7i12fhs8LeyUTyaK&amp;export=download'</span>, parse_dates=[<span class="hljs-string">'Date'</span>], date_parser=dateparse)
</code></pre>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_mobility</span><span class="hljs-params">(code, name)</span>:</span>
    mob = mobility[mobility.Code.eq(code)]
    colname = code + <span class="hljs-string">' '</span> + name
    mobranged = mob.loc[(mobility[<span class="hljs-string">'Date'</span>] &gt;= case_ranges[code][<span class="hljs-number">0</span>]) &amp; (mobility[<span class="hljs-string">'Date'</span>] &lt;= case_ranges[code][<span class="hljs-number">1</span>])];
    mobnamed = mobranged.reset_index().rename(columns={<span class="hljs-string">''</span>+name: colname})[colname]
    <span class="hljs-keyword">return</span> mobnamed

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">plot_item</span><span class="hljs-params">(name)</span>:</span>
    plt = pd.concat([extract_mobility(<span class="hljs-string">'GBR'</span>, name), extract_mobility(<span class="hljs-string">'SWE'</span>, name)], axis=<span class="hljs-number">1</span>).plot(grid=<span class="hljs-literal">True</span>)
</code></pre>
<pre><code class="language-python">plot_item(<span class="hljs-string">'Workplaces (%)'</span>)
plot_item(<span class="hljs-string">'Residential (%)'</span>)
plot_item(<span class="hljs-string">'Transit Stations (%)'</span>)
</code></pre>
<p><img src="/posts/uk-sweden-growth/output_13_0.png" alt="png"></p>
<p><img src="/posts/uk-sweden-growth/output_13_1.png" alt="png"></p>
<p><img src="/posts/uk-sweden-growth/output_13_2.png" alt="png"></p>
<p>Really interesting. Looks like already took matters into their own hands in the UK as much as possible starting March 11th. Things really only take off after March 15th though, with the reduction of workplaces.</p>
<p>Lets superimpose the two charts for the UK - the &quot;stay at home&quot; chart and the &quot;growth rate&quot; chart:</p>
<pre><code class="language-python">plt = pd.concat([extract_mobility(<span class="hljs-string">'GBR'</span>, <span class="hljs-string">'Residential (%)'</span>), growth(<span class="hljs-string">'GBR'</span>).rename(<span class="hljs-string">'GBR Growth * 10'</span>).iloc[:<span class="hljs-number">35</span>] * <span class="hljs-number">10</span>], axis=<span class="hljs-number">1</span>).plot(grid=<span class="hljs-literal">True</span>)
</code></pre>
<p><img src="/posts/uk-sweden-growth/output_15_0.png" alt="png"></p>
<p>Say what? Staying at home seems to overlap very well with the 21-day adjusted drop of the growth rate in deaths? Who would've thought.</p>
<p>Note that Sweden reacted to the pandemic a day or two days earlier than the UK did but the difference doesn't seem significant - it could largely be an artifact of us trying to align the moment where the virus was equally wide-spread within the population.</p>
<p>Regardless, its still wrong to compare UK with Sweden when the early pre-measures rates of growth are different. To show why, I will use a car analogy</p>
<h3>The car analogy</h3>
<p>Lets say we have two car models from the same company, World Cars. World cars are a bit quirky, they like to name their cars by countries in the world. We would like to decide which one to buy and one of the factors we're interested in is safety. Specifically, we want to know how well the brakes work.</p>
<p>To determine which car is better, we try to look up at some data on braking tests. We find the
following two datapoints for the cars:</p>
<table>
<thead>
<tr>
<th>Car name</th>
<th>Brake distance</th>
</tr>
</thead>
<tbody>
<tr>
<td>UK</td>
<td>32 m</td>
</tr>
<tr>
<td>Sweden</td>
<td>30 m</td>
</tr>
</tbody>
</table>
<p>Oh, nice. It looks like the brakes are pretty similar, with Sweden's being slightly better.</p>
<p>But then you notice something odd about these two tests. It looks like they were performed at
different initial speeds!</p>
<table>
<thead>
<tr>
<th>Car name</th>
<th>Brake distance</th>
<th>Initial speed</th>
</tr>
</thead>
<tbody>
<tr>
<td>UK</td>
<td>32 m</td>
<td>80 km/h</td>
</tr>
<tr>
<td>Sweden</td>
<td>30 m</td>
<td>40 km/h</td>
</tr>
</tbody>
</table>
<p>Wait a minute. This comparison makes no sense now! In fact its quite likely that the UK car brakes are way more effective,  being able to stop in just 32m from a starting speed of 80 km/h. A little <a href="https://www.johannes-strommer.com/diverses/pages-in-english/stopping-distance-acceleration-speed/">back of the napkin</a> math shows that UK's brake distance for an initial speed of 40 km/h would be just 8 meters:</p>
<table>
<thead>
<tr>
<th>Car name</th>
<th>Brake distance</th>
<th>Initial speed</th>
</tr>
</thead>
<tbody>
<tr>
<td>UK</td>
<td>8 m</td>
<td>40 km/h</td>
</tr>
<tr>
<td>Sweden</td>
<td>30 m</td>
<td>40 km/h</td>
</tr>
</tbody>
</table>
<p>Now lets look at the rate of growth chart for daily deaths again:</p>
<p><img src="/posts/uk-sweden-growth/output_7_0.png" alt="png"></p>
<p>Just as we can't compare the effectiveness of brakes by the distance traveled if the initial speed
is different, we can't compare the effectiveness of measures by the number of cases per million if
the initial rate of growth was different. Different rate of growth means that different brakes are
needed.</p>
<blockquote>
<p>Note: with cases its probably even worse as exponential (and near-exponential) growth is far more
dramatic than the quadratic growth caused by acceleration</p>
</blockquote>
</div><div class="comments"><hr/><a href="posts/uk-sweden-growth/index.html#_comments">comment or share</a></div></article><article class="post"><h1><a href="posts/machine-learning-ethics.html">Machine learning ethics</a></h1><div class="date">Tue Dec 19 2017</div><div class="content"><p>Today I found and watched one of the most important videos on machine learning published this year</p>
<blockquote>
<p>We're building a dystopia just to make people click on ads
https://www.youtube.com/watch?v=iFTWM7HV2UI&amp;app=desktop</p>
</blockquote>
<p>Go watch it first before reading ahead! I could not possibly summarise it without doing it a
disservice.</p>
<p>What struck me most was the following quote:</p>
<blockquote>
<p>Having interviewed people who worked at Facebook, I'm convinced that nobody there really
understands how it [the machine learning system] works.</p>
</blockquote>
<p>The important question is, howcome nobody understands how a machine learning system works? You
would think, its because the system is very complex, its hard for any one person to understand it
fully. Thats not the problem.</p>
<p>The problem is fundamental to machine learning systems.</p>
<p>A machine learning system is a program that is given a target goal, a list of possible actions,
a history of previous actions and how well they achieved the goal in a past context.
The system should learn on the historical data and be able to predict what action it can select to
best achieve the goal.</p>
<p>Lets see what these parts would represent on say, YouTube, for a ML system that has to pick which
videos to show on the sidebar right next to the video you're watching.</p>
<p>The target goal could be e.g. to maximise the time the user stays on YouTube, watching videos.
More generally, a <em>value function</em> is given by the ML system creator that measures the desireability
of a certain outcome or behaviour (it could include multiple things like number of product bought,
number of ads clicked or viewed, etc).</p>
<p>The action the system can take is the choice of videos in the sidebar. Every different set of videos
would be a different alternative action, and could cause the user to either stay on YouTube longer
or perhaps leave the site.</p>
<p>Finally, the history of actions includes all previous video lists shown in the sidebar to users,
together with the value function outcome from them: the time the user spent on the website after
being  presented that list. Additional context from that time is also included: which user was it,
what was their personal information, their past watching history, the channels they're subscribed
to, videos they liked, videos they disliked and so on.</p>
<p>Based on this data, the system learns how to tailor its actions (the videos it shows) so that it
achieves the goal by picking the right action for a given context.</p>
<p>At the beginning it will try random things. After several iterations, it will find which things
seem to maximize value in which context.</p>
<p>Once trained with sufficient data, it will be able to do some calculations and conclude: &quot;well,
when I encountered a situation like this other times, I tried these five options, and option two
on average caused users like this one to stay the longest, so I'll do that&quot;.</p>
<p>Sure, there are ways to ask some ML systems why they made a decision after the fact, and they can
elaborate the variables that had the most effect. But before the algorithm gets the training data,
you <em>don't</em> know what it will decide - nobody does! It learns from the history of its own actions
and how the users reacted to them, so in essence, the users are programming its behaviour (through
the lens of its value function).</p>
<p>Lets say the system learnt that people who have cat videos in their watch history will stay a lot
longer if they are given cat videos in their suggestion box. Nothing groundbreaking there.</p>
<p>Now lets say it figures out the same action is appropriate when they are watching something
unrelated, like academic lecture material, because past data suggests that people of that profile
leave slightly earlier when given more lecture videos, while they stay for hours when given cat
videos, giving up the lecture videos.</p>
<p>This raises a very important question - is the system behaving in an ethical manner? Is it ethical
to show cat videos to a person trying to study and nudge them towards wasting their time? Even that
is a fairly benign example. There are far worse examples mentioned in the TED talk above.</p>
<p>The root of the problem is the value function. Our systems are often blisfully unaware of any side
effects their decision may cause and blatantly disregard basic rules of behaviour that we take for
granted. They have no other values than the value function they're maximizing. For them, the end
justifies the means. Whether the value function is maximized by manipulating people, preying on
their insecurities, making them scared, angry or sad - all of that is unimportant. Here is a scary
proposition: if a person is epileptic, it might learn that the best way to keep thenm &quot;on the website&quot;
is to show them something that will render them unconscious. It wouldn't even know that it didn't
really achieve the goal: as far as it knows, autoplay is on and they haven't stopped it in the past
two hours, so it all must be &quot;good&quot;.</p>
<p>So how do we make these systems ethical?</p>
<p>The first challenge is technical, and its the easiest one. How do we come up with a value function
that encodes additional basic values of of human ethics? Its easy as pie! You take a bunch of
ethicists, give them various situations and ask them to rate actions as ethical/unethical. Then once
you have enough data, you train a new value function so that the system can learn some basic humanity.
You end up with a an ethics function, and you create a new value function that combines the old
value function with the ethics function into the new value function. As a result the system starts
picking more ethical actions. All done. (If only things were that easy!)</p>
<p>The second challenge is a business one. How far are you willing to reduce your value maximisation
to be ethical? What to do if your competitor doesn't do that? What are the ethics of putting a
number on how much ethics you're willing to sacrifice for profits? (Spoiler alert: they're not
great)</p>
<p>One way to solve that is to have regulations for ethical behaviour of machine learning systems.
Such systems could be held responsible for unethical actions. If those actions are reported by
people, investigated by experts and found true in court, the company owning the ML system is held
liable. Unethical behaviour of machine learning systems shouldn't be <em>too</em> difficult to spot,
although getting evidence might prove difficult. Public pressure and exposure of companies seems
to help too. Perhaps we could make a machine learning systems that detects unethical behaviour and
call it the ML police. Citizens could agree to install the ML police add-on to help monitor
and aggregate behaviour of online ML systems. (If these suggestions look silly, its because they
are).</p>
<p>Another way to deal with this is to mandate that all ML systems have a feedback feature.
The user (or a responsible guardian of the user) should be able to log on to the system, see its
past actions within a given context and rate them as ethical or unethical. The system must be
designed to use this data and give it precedence when making decisions, such that actions that are
computed to be more ethical are always picked over actions that are less ethical. In this scenario
the users are the ethicists.</p>
<p>The third challenge is philosophical. Until now, philosophers were content with &quot;there is no right
answer, but there have been many thoughts on what exactly is ethical&quot;. They better get their act
together, because we'll need them to come up with a definite, quantifiable answer real soon.</p>
<p>On the more optimistic side, I hope that any generally agreed upon &quot;standard&quot; ethical system will
be a better starting point than having none at all.</p>
</div><div class="comments"><hr/><a href="posts/machine-learning-ethics.html#_comments">comment or share</a></div></article><article class="post"><h1><a href="posts/javascript-is-not-cancer.html">JavaScript isn't cancer</a></h1><div class="date">Thu Oct 06 2016</div><div class="content"><p>The last few days, I've been thinking about what leads so many people to hate JavaScript.</p>
<p>JS is so quirky and unclean! Thats supposed to be the primary reason, but after working with a few other dynamic languages, I don't buy it. JS actually has a fairly small amount of quirks compared to other dynamic languages.</p>
<p>Just think about PHP's named functions, which are always in the global scope. Except when they are in namespaces (oh hi another concept), and then its kinda weird because <a href="https://stackoverflow.com/questions/13435051/relative-nested-namespaces-in-php">namespaces can be relative</a>. There are no first class named functions, but function expressions can be assigned to variables. Which must be prefixed with <code>$</code>. There are no real modules, or proper nestable scope - at least not for functions, which are always global. But nested functions only exist once the outer function is called!</p>
<p>In Ruby, blocks are like lambdas except when they are not, and you can pass a block explicitly or yield to the first block implicitly. But there are also lambdas, which are different. Modules are uselessly global, cannot be parameterised over other modules (without resorting to meta programming), and there are several ways to nest them: if you don't nest them lexically, <a href="https://cirw.in/blog/constant-lookup.html">the lookup rules become different</a>. And there are classes, with private variables, which are prefixed with <code>@</code>. I really don't get that sigil fetish.</p>
<p>The above examples are only scratching the surface.</p>
<p>And which are the most often cited problems of JavaScript? Implicit conversions (the wat talk), no large ints and hard to understand prototypical inheritance and <code>this</code> keyword. That doesn't look any worse than the above lists! Plus, the language (pre ES6) is very minimalistic. It has freeform records with prototypes, and closures with lexical scope. Thats it!</p>
<p>So this supposed &quot;quirkiness&quot; of JavaScript doesn't seem like a satisfactory explanation. There must be something else going on here, and I think I finally realized what that is.</p>
<p>JavaScript is seen as a &quot;low status&quot; language. A 10 day accident, a silly toy language for the browser that ought to be simple and easy to learn. To an extent this is true, largely thanks to the fact that there are very few distinct concepts to be learned.</p>
<p>However, those few concepts combine together into a package with a really good power-to-weight ratio. Additionally, the simplicity ensures that the language is malleable towards even more power (e.g. you can extend it with a type system and then you can <em>idiomatically</em> approximate some capabilities of algebraic sum types, like <a href="https://goo.gl/IkiZqx">making illegal states unrepresentable</a>).</p>
<p>The emphasis above is on <em>idiomatically</em> for a reason. This sort of extension is somehow perfectly normal in JavaScript. If you took Ruby and used its dictionary type to add a comparable feature, it has significantly lower likelyhood of being accepted by developers. Why? Because Ruby has standard ways of doing things. You should be using objects and classes, not hashes, to model most of your data. (*)</p>
<p>That was not the case with the simple pre-ES6 JavaScript. There was no module system to organize code. No classes system to hierarhically organize blueprints of things that hold state. Lack of basic standard library items, such as maps, sets, iterables, streams, promises. Lack of functions to manipulate existing data structures (dictionaries and arrays).</p>
<p>Combine sufficient power, simplicity/malleability, and the lack of the basic facilities. Add to this the fact that its the basic option in the browser, the most popular platform. What do you get? You get a TON of people working in it to extend it in various different ways. And they invent a TON of stuff!</p>
<p>We ended up with several popular module systems (object based namespaces, CommonJS, AMD, ES6, the angular module system, etc) as well as many package managers to manage these modules (npm, bower, jspm, ...). We also got many object/inheritance systems: plain objects, pure prototype extension, simulating classes, <a href="https://github.com/stampit-org/stampit">&quot;composable object factories&quot;</a>, and so on and so forth. Heck, a while ago every other library used to implement its own class system! <small>(That is, until CoffeeScript came and gave the definite answer on how to implement classes on top of prototypes. This is interesting, and I'll come back to it later.)</small></p>
<p>This creates dissonance with the language's simplicity. JavaScript is this simple browser language that was supposed to be easy, so why is it so hard? Why are there so many things built on top of it and how the heck do I choose which one to use? I hate it. Why do I hate it? Probably its all these silly quirks that it has! Just look at its implicit conversions and lack of number types other than doubles!</p>
<p>It doesn't matter that many languages are much worse. A great example of the reverse phenomenon is C++. Its a <a href="http://yosefk.com/c++fqa/">complete abomination</a>, far worse than JavaScript - a Frankenstein in the languages domain. But its seen as &quot;high status&quot;, so it has many apologists that will come to defend its broken design: &quot;Yeah, C++ is a serious language, you need grown-up pants to use it&quot;. Unfortunately JS has no such luck: its status as a hack-together glue for the web pages seems to have been forever cemented in people's heads.</p>
<p>So how do we fix this? You might not realize it, but this is already being fixed as we speak! Remember how CoffeeScript slowed down the prolification of custom object systems? Browsers and environments are quickly implementing ES6, which standardizes a huge percentage of what used to be the JS wild west. We now have the standard way to do modules, the standard way to do classes, the standard way to do basic procedural async (Promises; async/await). The standard way to do bundling will probably be no-bundling: <a href="https://esdiscuss.org/topic/fwd-are-es6-modules-in-browsers-going-to-get-loaded-level-by-level#content-4">HTTP2 push + ES6 modules will &quot;just work&quot;</a>!</p>
<p>Finally, I believe the people who think that JavaScript will always be transpiled are wrong. As ES6+ features get implemented in major browsers, more and more people will find the overhead of ES.Next to ES transpilers isn't worth it. This process will stop entirely at some point as the basics get fully covered.</p>
<p>At this point, I'm hoping several things will happen. We'll finally get those big integers and number types that Brendan Eich has been promising. We'll have some more stuff on top of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">SharedArrayBuffer</a> to enable easier shared memory parallelism, perhaps even <a href="https://facebook.github.io/immutable-js/">immutable datastructures</a> that are <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#Passing_data_by_transferring_ownership_(transferable_objects)">transferable objects</a>. The wat talk will be obsolete: obviously, you'd be using a static analysis tool such as <a href="https://flowtype.org/">Flow</a> or TypeScript to deal with that; the fact that the browser ignores those type annotations and does its best to interpret what you meant will be irrelevant. async/await will be implemented in all browsers as the de-facto way to do async control flow; perhaps even <a href="https://github.com/tc39/proposal-async-iteration">async iterators</a> too. We'll also have widly accepted standard libraries for <a href="https://github.com/whatwg/streams">data</a> and event streams.</p>
<p>Will JavaScript finally gain the status it deserves then? Probably. But at what cost? JavaScript is big enough now that there is less space for new inventions. And its fun to invent new things and read about other people's inventions!</p>
<p>On the other hand, maybe then we'll be able to focus on the stuff we're actually building instead.</p>
<p><small>(*) Or metaprogramming, but then everyone has to agree on the same metaprogramming. In JS,
everyone uses records, and they probably use a tag field to discriminate them already: its a small step to add types for that.</small></p>
</div><div class="comments"><hr/><a href="posts/javascript-is-not-cancer.html#_comments">comment or share</a></div></article><article class="post"><h1><a href="posts/es7-async-await-step-in-the-wrong-direction.html">ES7 async functions - a step in the wrong direction</a></h1><div class="date">Sun Aug 23 2015</div><div class="content"><p>Async functions are a new feature scheduled to become a part of ES7. They build
on top of previous capabilities made available by ES6 (promises), letting you
write async code as though it were synchronous. At the moment, they're a
<a href="https://github.com/lukehoban/ecmascript-asyncawait">stage 1 proposal for ES7</a> and supported by babel /
regenerator.</p>
<p>When generator functions were first made available in node, I was
<a href="https://spion.github.io/posts/analysis-generators-and-other-async-patterns-node.html">very excited</a>. Finally, a way to write asynchronous JavaScript that
doesn't descend into callback hell! At the time, I was unfamiliar with promises
and the language power you get back by simply having async computations be
first class values, so it seemed to me that generators are the best solution
available.</p>
<p>Turns out, they aren't. And the same limitations apply for async functions.</p>
<h3>Predicates in catch statements</h3>
<p>With generators, thrown errors bubble up the function chain until a catch
statement is encountered, much like in other languages that support exceptions.
On one hand, this is convenient, but on the other, you never know what you're
catching once you write a catch statement.</p>
<p>JavaScript catch doesn't support any mechanism to filter errors. This
limitation isn't too hard to get around: we can write a function <code>guard</code></p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">guard</span>(<span class="hljs-params">e, predicate</span>) </span>{
  <span class="hljs-keyword">if</span> (!predicate(e)) <span class="hljs-keyword">throw</span> e;
}
</code></pre>
<p>and then use it to e.g. only filter &quot;not found&quot; errors when downloading an
image</p>
<pre><code class="language-js"><span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> downloadImage(url);
} <span class="hljs-keyword">catch</span> (e) { guard(e, e =&gt; e.code == <span class="hljs-number">404</span>);
    handle404(...);
}
</code></pre>
<p>But that only gets us so far. What if we want to have a second error handler?
We must resort to using <code>if-then-else</code>, making sure that we don't forget to
rethrow the error at the end</p>
<pre><code class="language-js"><span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> downloadImage(url);
} <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">if</span> (e.code == <span class="hljs-number">404</span>)  {
        handle404(...)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.code == <span class="hljs-number">401</span>) {
        handle401(...);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<p>Since promises are a userland library, restrictions like the above do not
apply. We can write our own promise implementation that demands the use of a
predicate filter:</p>
<pre><code class="language-js">downloadImage(url)
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.code == <span class="hljs-number">404</span>, e =&gt; {
    handle404(...);
})
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.code == <span class="hljs-number">401</span>, e =&gt; {
    handle401(...)
})
</code></pre>
<p>Now if we want all errors to be caught, we have to say it explicitly:</p>
<pre><code class="language-js">asyncOperation()
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-literal">true</span>, e =&gt; {
    handleAllErrors(...)
});
</code></pre>
<p>Since these constructs are not built-in language features but a DSL built on
top of higher order functions, we can impose any restrictions we like instead
of waiting on TC39 to fix the language.</p>
<h3>Cannot use higher order functions</h3>
<p>Because generators and async-await are shallow, you cannot use <code>yield</code> or
<code>await</code> within lambdas passed to higher order functions.</p>
<p>This is <a href="https://github.com/tc39/ecmascript-asyncawait/issues/7">better explained here</a> - The example given
there is</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderChapters</span>(<span class="hljs-params">urls</span>) </span>{
  urls.map(getJSON).forEach(<span class="hljs-function"><span class="hljs-params">j</span> =&gt;</span> addToPage((<span class="hljs-keyword">await</span> j).html));
}
</code></pre>
<p>and will not work, because you're not allowed to use await from within a nested
function. The following will work, but will execute in parallel:</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderChapters</span>(<span class="hljs-params">urls</span>) </span>{
  urls.map(getJSON).forEach(<span class="hljs-keyword">async</span> j =&gt; addToPage((<span class="hljs-keyword">await</span> j).html));
}
</code></pre>
<p>To understand why, you need to read <a href="http://calculist.org/blog/2011/12/14/why-coroutines-wont-work-on-the-web/">this article</a>. In short:
its much harder to implement deep coroutines so browser vendors probably wont
do it.</p>
<p>Besides being very unintuitive, this is also limiting. Higher order functions
are succint and powerful, yet we cannot <em>really</em> use them inside async
functions. To get sequential execution we have to resort to the clumsy built
in for loops which often force us into writing ceremonial, stateful code.</p>
<h3>Arrow functions give us more power than ever before</h3>
<p>Functional DSLs were very powerful even before JS had short lambda syntax. But
with arrow functions, things get even cleaner. The amount of code one needs to
write can be reduced greatly thanks to short lambda syntax and higher order
functions. Lets take the motivating example from the async-await proposal</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chainAnimationsPromise</span>(<span class="hljs-params">elem, animations</span>) </span>{
    <span class="hljs-keyword">var</span> ret = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> p = currentPromise;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> anim <span class="hljs-keyword">of</span> animations) {
        p = p.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
            ret = val;
            <span class="hljs-keyword">return</span> anim(elem);
        })
    }
    <span class="hljs-keyword">return</span> p.catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-comment">/* ignore and keep going */</span>
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> ret;
    });
}
</code></pre>
<p>With bluebird's <code>Promise.reduce</code>, this becomes</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chainAnimationsPromise</span>(<span class="hljs-params">elem, animations</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reduce(animations,
      (lastVal, anim) =&gt; anim(elem).catch(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-built_in">Promise</span>.reject(lastVal)),
      <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">null</span>))
  .catch(<span class="hljs-function"><span class="hljs-params">lastVal</span> =&gt;</span> lastVal);
}
</code></pre>
<p>In short: functional DSLs are now more powerful than built in constructs,
even though (admittedly) they may take some getting used to.</p>
<hr>
<p>But this is not why async functions are a step in the wrong direction. The
problems above are not unique to async functions. The same problems apply to
generators: async functions merely inherit them as they're very similar.</p>
<p>Async functions also go another step backwards.</p>
<h2>Loss of generality and power</h2>
<p>Despite their shortcomings, generator based coroutines have one redeeming
quality: they allow you to redefine the coroutine execution engine. This is
extremely powerful, and I will demonstrate by giving the following example:</p>
<p>Lets say we were given the task to write the save function for an issue
tracker. The issue author can specify the issue's title and text, as well
as any other issues that are blocking the solution of the newly entered issue.</p>
<p>Our initial implementation is simple:</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveIssue</span>(<span class="hljs-params">data, blockers</span>) </span>{
    <span class="hljs-keyword">let</span> issue = <span class="hljs-keyword">await</span> Issues.insert(data);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> blockerId <span class="hljs-keyword">of</span> blockers) {
      <span class="hljs-keyword">await</span> BlockerIssues.insert({<span class="hljs-attr">blocker</span>: blockerId, <span class="hljs-attr">blocks</span>: issue.id});
    }
}

Issues.insert = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT ... VALUES"</span>, data).execWithin(db.pool);
}

BlockerIssue.insert = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT .... VALUES"</span>, data).execWithin(db.pool);
}
</code></pre>
<p><code>Issue</code> and <code>BlockerIssues</code> are references to the corresponding tables in an
SQL database. Their <code>insert</code> methods return a promise that indicate whether
the query has been completed. The query is executed by a connection pool.</p>
<p>But then, we run into a problem. We don't want to partially save the issue if
some of the data was not inserted successfuly. We want the entire save
operation to be atomic. Fortunately, SQL databases support this via
transactions, and our database library has a transaction abstraction. So we
change our code:</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveIssue</span>(<span class="hljs-params">data, blockers</span>) </span>{
    <span class="hljs-keyword">let</span> tx = db.beginTransaction();
    <span class="hljs-keyword">let</span> issue = <span class="hljs-keyword">await</span> Issue.insert(tx, data);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> blockerId <span class="hljs-keyword">of</span> blockers) {
      <span class="hljs-keyword">await</span> BlockerIssues.insert(tx, {<span class="hljs-attr">blocker</span>: blockerId, <span class="hljs-attr">blocks</span>: issue.id});
    }
}

Issues.insert = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tx, data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT ... VALUES"</span>, data).execWithin(tx);
}

BlockerIssue.insert = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tx, data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT .... VALUES"</span>, data).execWithin(tx);
}
</code></pre>
<p>Here, we changed the code in two ways. Firstly, we created a transaction within
the saveIssue function. Secondly, we changed both insert methods to take this
transaction as an argument.</p>
<p>Immediately we can see that this solution doesn't scale very well. What if
we need to use <code>saveIssue</code> as a part of a larger transaction? Then it has to
take a transaction as an argument. Who will create the transactions? The top
level service. What if the top level service becomes a part of a larger
service? Then we need to change the code again.</p>
<p>We can reduce the extent of this problem by writing a base class that
automatically initializes a transaction if one is not passed via the
constructor, and then have <code>Issues</code>, <code>BlockerIssue</code> etc inherit from this
class.</p>
<pre><code class="language-js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Transactionable</span> </span>{
    <span class="hljs-keyword">constructor</span>(tx) {
        <span class="hljs-keyword">this</span>.transaction = tx || db.beginTransaction();
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IssueService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Transactionable</span> </span>{
    <span class="hljs-keyword">async</span> saveIssue(data, blockers) {
        issues = <span class="hljs-keyword">new</span> Issues(<span class="hljs-keyword">this</span>.transaction);
        blockerIssues = <span class="hljs-keyword">new</span> BlockerIssues(<span class="hljs-keyword">this</span>.transaction);
        ...
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Issues</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Transactionable</span> </span>{ ... }
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockerIssues</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Transactionable</span> </span>{ ... }
<span class="hljs-comment">// etc</span>
</code></pre>
<p>Like many OO solutions, this only spreads the problem across the plate to make
it look smaller but doesn't solve it.</p>
<h2>Generators are better</h2>
<p>Generators let us define the execution engine. The iteration is driven by the
function that consumes the generator, which decides what to do with the yielded
values. What if instead of only allowing promises, our engine let us also:</p>
<ol>
<li>Specify additional options which are accessible from within</li>
<li>Yield queries. These will be run in the transaction specified in the options
above</li>
<li>Yield other generator iterables: These will be run with the same engine and
options</li>
<li>Yield promises: These will be handled normally</li>
</ol>
<p>Lets take the original code and simplify it:</p>
<pre><code class="language-js">
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">saveIssue</span>(<span class="hljs-params">data, blockers</span>) </span>{
    <span class="hljs-keyword">let</span> issue = <span class="hljs-keyword">yield</span> Issues.insert(data);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> blockerId <span class="hljs-keyword">of</span> blockers) {
      <span class="hljs-keyword">yield</span> BlockerIssues.insert({<span class="hljs-attr">blocker</span>: blockerId, <span class="hljs-attr">blocks</span>: issue.id});
    }
}

Issues.insert = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT ... VALUES"</span>, data)
}

BlockerIssue.insert = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">return</span> db.query(<span class="hljs-string">"INSERT .... VALUES"</span>, data)
}
</code></pre>
<p>From our http handler, we can now write</p>
<pre><code class="language-js"><span class="hljs-keyword">var</span> myengine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./my-engine'</span>);

app.post(<span class="hljs-string">'/issues/save'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  myengine.run(saveIssue(data, blockers), {<span class="hljs-attr">tx</span>: db.beginTransaction()})
});
</code></pre>
<p>Lets implement this engine:</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">iterator, options</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">id</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> x; }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterate</span>(<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">var</span> next = iterator.next(value)
        <span class="hljs-keyword">var</span> request = next.value;
        <span class="hljs-keyword">var</span> nextAction = next.done ? id : iterate;

        <span class="hljs-keyword">if</span> (isIterator(request)) {
            <span class="hljs-keyword">return</span> run(request, options).then(nextAction)
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isQuery(request)) {
            <span class="hljs-keyword">return</span> request.execWithin(options.tx).then(nextAction)
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isPromise(request)) {
            <span class="hljs-keyword">return</span> request.then(nextAction);
        }
    }
    <span class="hljs-keyword">return</span> iterate()
}
</code></pre>
<p>The best part of this change is that we did not have to change the original
code at all. We didn't have to add the transaction parameter to every function,
to take care to properly propagate it everywhere and to properly create the
transaction. All we needed to do is just change our execution engine.</p>
<p>And we can add much more! We can <code>yield</code> a request to get the current user
if any, so we don't have to thread that through our code. Infact we can
implement <a href="https://github.com/othiym23/node-continuation-local-storage">continuation local storage</a> with only a few lines of code.</p>
<p>Async generators are often given as a reason why we need async functions. If
yield is already being used as await, how can we get both working at the same
time without adding a new keyword? Is that even possible?</p>
<p>Yes. Here is a simple proof-of-concept.
<a href="https://github.com/spion/async-generators">github.com/spion/async-generators</a>.
All we needed to do is change the execution engine to support a mechanism
to distinguish between awaited and yielded values.</p>
<p>Another example worth exploring is a query optimizer that supports aggregate
execution of queries. If we replace <code>Promise.all</code> with our own implementaiton
caled <code>parallel</code>, then we can add support for non-promise arguments.</p>
<p>Lets say we have the following code to notify owners of blocked issues in
parallel when an issue is resolved:</p>
<pre><code class="language-js"><span class="hljs-keyword">let</span> blocked = <span class="hljs-keyword">yield</span> BlockerIssues.where({<span class="hljs-attr">blocker</span>: blockerId})
<span class="hljs-keyword">let</span> owners  = <span class="hljs-keyword">yield</span> engine.parallel(blocked.map(<span class="hljs-function"><span class="hljs-params">issue</span> =&gt;</span> issue.getOwner()))

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> owner <span class="hljs-keyword">of</span> owners) <span class="hljs-keyword">yield</span> owner.notifyResolved(issue)
</code></pre>
<p>Instead of returning an SQL based query, we can have <code>getOwner()</code> return data
about the query:</p>
<pre><code class="language-js">{<span class="hljs-attr">table</span>: <span class="hljs-string">'users'</span>, <span class="hljs-attr">id</span>: issue.user_id}
</code></pre>
<p>and have <code>engine</code> optimize the execution of parallel queries, by sending
a single query per table rather then per item.</p>
<pre><code class="language-js"><span class="hljs-keyword">if</span> (isParallelQuery(query)) {
    <span class="hljs-keyword">var</span> results = _(query.items).groupBy(<span class="hljs-string">'table'</span>)
      .map(<span class="hljs-function">(<span class="hljs-params">items, t</span>) =&gt;</span> db.query(<span class="hljs-string">`select * from <span class="hljs-subst">${t}</span> where id in ?`</span>,
                                  items.map(<span class="hljs-function"><span class="hljs-params">it</span> =&gt;</span> it.id))
                .execWithin(options.tx)).toArray();
    <span class="hljs-built_in">Promise</span>.all(results)
        .then(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> results.sort(byOrderOf(query.items)))
        .then(runNext)
}
</code></pre>
<p>And voila, we've just implemented a query optimizer. It will fetch all issue
owners with a single query. If we add an SQL parser into the mix, it should
be possible to rewrite real SQL queries.</p>
<p>We can do something similar on the client too with GraphQL queries by aggregating
multiple individual queries.</p>
<p>And if we add support for iterators, the optimization becomes deep:
we would be able to aggregate queries that are several layers within other
generator functions,  In the above example, <code>getOwner()</code> could be another
generatator which produces a query for the user as a first result. Our
implementation of <code>parallel</code> will run all those getOwner() iterators and
consolidate their first queries into a single query. All this is done without
those functions knowing anything about it (thus, without breaking modularity).</p>
<p>Async functions cant let us do any of this. All we get is a single execution
engine that only knows how to await promises. To make matters worse, thanks
to the unfortunately short-sighted <a href="https://esdiscuss.org/topic/a-challenge-problem-for-promise-designers-was-re-futures">recursive thenable assimilation</a>
design decision, we can't simply create our own thenable that will support
the above extra features. If we try to do that, we will be
<a href="https://github.com/Reactive-Extensions/RxJS/issues/470">unable to safely use it with Promises</a>.
We're stuck with what we get by default in async functions, and
thats it.</p>
<p>Generators are JavaScript's programmable semicolons. Lets not take away that
power by taking away the programmability. Lets drop async/await and write our
own interpreters.</p>
</div><div class="comments"><hr/><a href="posts/es7-async-await-step-in-the-wrong-direction.html#_comments">comment or share</a></div></article><hr/><h1>Older posts</h1><h4 class="post"><a href="posts/why-i-am-switching-to-promises.html">Why I am switching to promises</a></h4><h4 class="post"><a href="posts/closures-are-unavoidable-in-node.html">Closures are unavoidable in node</a></h4><h4 class="post"><a href="posts/analysis-generators-and-other-async-patterns-node.html">Analysis of generators and other async patterns in node</a></h4><h4 class="post"><a href="posts/make-most-webapps-work-on-ipad.html">Google Docs on the iPad</a></h4><h4 class="post"><a href="posts/introducing-npmsearch.html">Introducing npmsearch</a></h4><h4 class="post"><a href="posts/fixing-hackernews-mathematical-approach.html">Fixing Hacker News with a reputation system</a></h4><h4 class="post"><a href="posts/let-it-snow.html">Let it snow</a></h4><h4 class="post"><a href="posts/why-native-sucks--rocks-porting-windows-8.html">Why native sucks and HTML5 rocks</a></h4><h4 class="post"><a href="posts/intuitive-javascript-array-filtering-function-pt2.html">Intuitive JavaScript array filtering function pt2</a></h4><h4 class="post"><a href="posts/intuitive-javascript-array-filtering-function.html">Intuitive JavaScript array filtering function pt1</a></h4><h4 class="post"><a href="posts/amateur-lasse-gjertsen.html">Amateur - Lasse Gjertsen</a></h4></div></main></div><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.css"><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script src="/scripts/jquery.flot.js"></script><script src="/scripts/jquery.flot.highlightSeries.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1803JM8K3L"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-1803JM8K3L');</script></body></html>